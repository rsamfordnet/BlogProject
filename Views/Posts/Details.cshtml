@using BlogProject.Services
@using Microsoft.AspNetCore.Identity
@using Newtonsoft.Json

@model BlogProject.Models.Post

@inject IImageService imageService 
@inject UserManager<BlogUser> userManager

@{
    ViewData["Title"] = "Details";
}


<!-- Post Content -->
<main id="main">

    <section class="single-post-content">
        <div class="container">
            <div class="row">
                <div class="col-md-9 post-content" data-aos="fade-up">

                    <!-- ======= Single Post Content ======= -->
                    @Html.Raw(Model.Content)
                    <!-- Displaying Comments related to this Post -->
                    <!-- Display the image of the Comment's Author -->
                
                    </div><!-- End Single Post Content -->
                <div class="col-md-3">
                    <div class="aside-block">
                        <h3 class="aside-title">Tags</h3>
                        <ul class="aside-tags list-unstyled">
                            <li>
                                @foreach (var tag in Model.Tags)
                                {
                                    <a asp-action="TagIndex" asp-route-tag="@tag.Text.ToLower()">#@tag.Text</a>
                                }
                            </li>

                        </ul>
                    </div><!-- End Tags -->
                    
                    

                </div>
            
                <div>

                    @if (User.Identity.IsAuthenticated)
                    {
                        <form asp-action="Create" asp-controller="Comments" method="post">
                            @Html.Hidden("PostId", Model.Id)

                            <div class="form-group">
                                <label class="h2 control-label font-weight-bold">Add Comment</label>
                                <textarea name="body" class="form-control" rows="10"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary"> Submit</button>


                        </form>

                    }
                    else
                    {
                        <a class="btn btn-dark" asp-area="Identity" asp-page="/Account/Login">
                            Login to Add Comments
                        </a>

                    }
                </div>
            </div>
            </div>
        </div>
    </section>
</main><!-- End #main -->

<hr />


<button id="commentSection" class="btn btn-sm btn-dark">@Model.Comments.Count COMMENTS </button>
@{ var counter = 0;}
@foreach (var comment in Model.Comments)
  {
    <div class="gslide-media media-border p-0 mb-2 bg-light">
        <img class="mr-3 mt-3 rounded-circle" style="width:60px;" src="@imageService.DecodeImage(comment.BlogUser.ImageData, comment.BlogUser.ContentType)"/>
        <div class="media-body">
            <h4>@comment.BlogUser.FullName</h4>
            <small><i>Posted on @comment.Created.ToString("MMM dd, yyyy")</i></small>
            <p>@comment.Body</p>
            @****************************************
        ********SECTION 1: Render The Edit Button ************************
        ******************************************************@
            @if (comment.Moderated is null && comment.Deleted is null && comment.BlogUserId == userManager.GetUserId(User))
            {
                <hr />
                <button data-bs-toggle="modal" data-bs-target="#editModal" class="btn-sm btn-dark note-float-right">EDIT</button>
            }
            @****************************************
        ********SECTION 2: Render The Moderate and Delete Buttons ************************
        ******************************************************@
        @if (User.IsInRole(BlogRole.Moderator.ToString()) && comment.Deleted is null)
                {
                    <hr />
                    <div class="row">
                        <div class="col-2">
                            <button class="btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="@($"#moderateModal{counter}")">MODERATE</button>
                        </div>
                        <div class="col-2">
                            <form asp-action="Delete" asp-controller="Comments">
                                @Html.Hidden("Id",comment.Id)
                                @Html.Hidden("Slug",comment.Post.Slug)
                                <button class="btn-dark btn-sm">DELETE</button>
                            </form>
                        </div>
                    </div>
                }

        </div>
    </div>  

    @*Modals*@

    <div class="modal" id="@($"moderateModal{counter}")">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Editing Comment...</h4>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <form asp-action="Edit" asp-controller="Comments">
                        @Html.Hidden("Id", comment.Id)

                        <div class="form-group">
                            <textarea name="Body" class="form-control" required>@comment.Body</textarea>
                        </div>

                        <button class="btn-sm btn-dark border-success font-weight-bold" type="submit">SUBMIT</button>
                    </form>
                </div>

                <!-- Modal footer-->
                <div class="modal-footer">
                    <button type="button" class="btn-sm btn-dark font-weight-bold" data-bs-dismiss="modal">CLOSE</button>
                </div>


            </div>
        </div>
    </div>
    counter++;
}
<!-- Displaying Comments related to this Post -->
<!-- Display the image of the Comment's Author -->